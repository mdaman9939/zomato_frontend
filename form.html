<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>DarkPan - Bootstrap 5 Admin Template</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="" name="keywords" />
    <meta content="" name="description" />
    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon" />
    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@500;700&display=swap"
      rel="stylesheet"
    />
    <!-- Icon Font Stylesheet -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- Libraries Stylesheet -->
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet" />
    <link
      href="lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css"
      rel="stylesheet"
    />
    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet" />
    <style>
      .chat-image-preview {
        max-width: 150px;
        max-height: 150px;
        border-radius: 5px;
        margin: 5px;
        border: 1px solid #444;
      }
      .image-preview-container {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }
      .image-preview-item {
        position: relative;
        margin-right: 10px;
        margin-bottom: 10px;
      }
      .remove-image-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #ff4d4d;
        color: white;
        border: none;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid position-relative d-flex p-0">
      <!-- Spinner Start -->
      <div
        id="spinner"
        class="show bg-dark position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center"
      >
        <div
          class="spinner-border text-primary"
          style="width: 3rem; height: 3rem"
          role="status"
        >
          <span class="sr-only">Loading...</span>
        </div>
      </div>
      <!-- Spinner End -->
      <!-- Sidebar Start -->
      <div class="sidebar pe-4 pb-3">
        <nav class="navbar bg-secondary navbar-dark">
          <a href="index.html" class="navbar-brand mx-4 mb-3">
            <h3 class="text-primary">
              <i class="fa fa-user-edit me-2"></i>DarkPan
            </h3>
          </a>
          <div class="d-flex align-items-center ms-4 mb-4">
            <div class="position-relative">
              <img
                class="rounded-circle"
                src="img/user.jpg"
                alt=""
                style="width: 40px; height: 40px"
              />
              <div
                class="bg-success rounded-circle border border-2 border-white position-absolute end-0 bottom-0 p-1"
              ></div>
            </div>
            <div class="ms-3">
              <h6 class="mb-0">Jhon Doe</h6>
              <span>Admin</span>
            </div>
          </div>
          <div class="navbar-nav w-100">
            <a href="index.html" class="nav-item nav-link"
              ><i class="fa fa-tachometer-alt me-2"></i>Dashboard</a
            >

            <a href="form.html" class="nav-item nav-link active"
              ><i class="fa fa-keyboard me-2"></i>Forms</a
            >
          </div>
        </nav>
      </div>
      <!-- Sidebar End -->
      <!-- Content Start -->
      <div class="content">
        <!-- Navbar Start -->
        <nav
          class="navbar navbar-expand bg-secondary navbar-dark sticky-top px-4 py-0"
        >
          <a href="index.html" class="navbar-brand d-flex d-lg-none me-4">
            <h2 class="text-primary mb-0"><i class="fa fa-user-edit"></i></h2>
          </a>
          <a href="#" class="sidebar-toggler flex-shrink-0">
            <i class="fa fa-bars"></i>
          </a>
          <form class="d-none d-md-flex ms-4">
            <input
              class="form-control bg-dark border-0"
              type="search"
              placeholder="Search"
            />
          </form>
          <div class="navbar-nav align-items-center ms-auto">
            <div class="nav-item dropdown">
              <a
                href="#"
                class="nav-link dropdown-toggle"
                data-bs-toggle="dropdown"
              >
                <i class="fa fa-envelope me-lg-2"></i>
                <span class="d-none d-lg-inline-flex">Message</span>
              </a>
              <div
                class="dropdown-menu dropdown-menu-end bg-secondary border-0 rounded-0 rounded-bottom m-0"
              >
                <a href="#" class="dropdown-item">
                  <div class="d-flex align-items-center">
                    <img
                      class="rounded-circle"
                      src="img/user.jpg"
                      alt=""
                      style="width: 40px; height: 40px"
                    />
                    <div class="ms-2">
                      <h6 class="fw-normal mb-0">Jhon send you a message</h6>
                      <small>15 minutes ago</small>
                    </div>
                  </div>
                </a>
                <hr class="dropdown-divider" />
                <a href="#" class="dropdown-item">
                  <div class="d-flex align-items-center">
                    <img
                      class="rounded-circle"
                      src="img/user.jpg"
                      alt=""
                      style="width: 40px; height: 40px"
                    />
                    <div class="ms-2">
                      <h6 class="fw-normal mb-0">Jhon send you a message</h6>
                      <small>15 minutes ago</small>
                    </div>
                  </div>
                </a>
                <hr class="dropdown-divider" />
                <a href="#" class="dropdown-item">
                  <div class="d-flex align-items-center">
                    <img
                      class="rounded-circle"
                      src="img/user.jpg"
                      alt=""
                      style="width: 40px; height: 40px"
                    />
                    <div class="ms-2">
                      <h6 class="fw-normal mb-0">Jhon send you a message</h6>
                      <small>15 minutes ago</small>
                    </div>
                  </div>
                </a>
                <hr class="dropdown-divider" />
                <a href="#" class="dropdown-item text-center"
                  >See all message</a
                >
              </div>
            </div>
            <div class="nav-item dropdown">
              <a
                href="#"
                class="nav-link dropdown-toggle"
                data-bs-toggle="dropdown"
              >
                <i class="fa fa-bell me-lg-2"></i>
                <span class="d-none d-lg-inline-flex">Notificatin</span>
              </a>
              <div
                class="dropdown-menu dropdown-menu-end bg-secondary border-0 rounded-0 rounded-bottom m-0"
              >
                <a href="#" class="dropdown-item">
                  <h6 class="fw-normal mb-0">Profile updated</h6>
                  <small>15 minutes ago</small>
                </a>
                <hr class="dropdown-divider" />
                <a href="#" class="dropdown-item">
                  <h6 class="fw-normal mb-0">New user added</h6>
                  <small>15 minutes ago</small>
                </a>
                <hr class="dropdown-divider" />
                <a href="#" class="dropdown-item">
                  <h6 class="fw-normal mb-0">Password changed</h6>
                  <small>15 minutes ago</small>
                </a>
                <hr class="dropdown-divider" />
                <a href="#" class="dropdown-item text-center"
                  >See all notifications</a
                >
              </div>
            </div>
            <div class="nav-item dropdown">
              <a
                href="#"
                class="nav-link dropdown-toggle"
                data-bs-toggle="dropdown"
              >
                <img
                  class="rounded-circle me-lg-2"
                  src="img/user.jpg"
                  alt=""
                  style="width: 40px; height: 40px"
                />
                <span class="d-none d-lg-inline-flex">John Doe</span>
              </a>
              <div
                class="dropdown-menu dropdown-menu-end bg-secondary border-0 rounded-0 rounded-bottom m-0"
              >
                <a href="#" class="dropdown-item">My Profile</a>
                <a href="#" class="dropdown-item">Settings</a>
                <a href="signin.html" class="dropdown-item">Log Out</a>
              </div>
            </div>
          </div>
        </nav>
        <!-- Navbar End -->
        <!-- Chatbot Form Start -->
        <div class="bg-secondary rounded h-100 p-4">
          <h6 class="mb-4">AI Chatbot</h6>
          <div
            id="chat-box"
            class="border border-light bg-dark text-white p-3 mb-3"
            style="height: 300px; overflow-y: auto; border-radius: 5px"
          ></div>
          <!-- Image preview container -->
          <div
            id="image-preview-container"
            class="image-preview-container"
          ></div>
          <div class="input-group mb-2">
            <input
              type="text"
              id="user-input"
              class="form-control bg-dark border-secondary text-white"
              placeholder="Type your message..."
            />
            <button class="btn btn-primary" type="button" id="send-button">
              Send
            </button>
          </div>
          <div class="input-group">
            <input
              type="file"
              id="image-upload"
              multiple
              accept="image/*"
              class="form-control"
            />
            <button class="btn btn-info" id="upload-button">
              Upload Images
            </button>
          </div>
        </div>
        <!-- Chatbot Form End -->
        <!-- Footer Start -->
        <div class="container-fluid pt-4 px-4">
          <div class="bg-secondary rounded-top p-4">
            <div class="row">
              <div class="col-12 col-sm-6 text-center text-sm-start">
                &copy;
                <a href="https://mdaman.vercel.app" target="_blank">Md Aman</a>,
                All Right Reserved.
              </div>
              <div class="col-12 col-sm-6 text-center text-sm-end">
                Designed By <a href="https://htmlcodex.com">HTML Codex</a>
                <br />Distributed By:
                <a href="https://themewagon.com" target="_blank">ThemeWagon</a>
              </div>
            </div>
          </div>
        </div>
        <!-- Footer End -->
      </div>
      <!-- Content End -->
      <!-- Back to Top -->
      <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"
        ><i class="bi bi-arrow-up"></i
      ></a>
    </div>
    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/chart/chart.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="lib/tempusdominus/js/moment.min.js"></script>
    <script src="lib/tempusdominus/js/moment-timezone.min.js"></script>
    <script src="lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>
    <!-- Template Javascript -->
    <script src="js/main.js"></script>
    <script>
            // Global variables
            let currentStep = null;
            let uploadedImages = [];
            // DOM elements
            const chatBox = document.getElementById("chat-box");
            const userInput = document.getElementById("user-input");
            const imageUpload = document.getElementById("image-upload");
            const sendButton = document.getElementById("send-button");
            const uploadButton = document.getElementById("upload-button");
            const imagePreviewContainer = document.getElementById(
              "image-preview-container"
            );
            // Event listeners
            document.addEventListener("DOMContentLoaded", function () {

              const form = document.querySelector("form"); // agar form ka tag hai
              if (form) {
                form.addEventListener("submit", function(event) {
                  event.preventDefault(); // page reload stop
                });
              }

              // Prevent form submissions from causing page reload
              document.addEventListener("submit", function (event) {
                event.preventDefault();
                event.stopPropagation();
              });
              // Send message on button click
              sendButton.addEventListener("click", sendMessage);
              // Send message on Enter key
              userInput.addEventListener("keydown", function (event) {
                if (event.key === "Enter") {
                  sendMessage();
                }
              });
              // Handle image upload button click
              uploadButton.addEventListener("click", function () {
                imageUpload.click();
              });
              // Handle image selection
              imageUpload.addEventListener("change", handleImageSelection);
            });

            // Handle image selection
            function handleImageSelection(event) {
              const files = event.target.files;
              if (!files || files.length === 0) return;
              // Process each selected file
              Array.from(files).forEach((file) => {
                if (!file.type.match("image.*")) return;
                // Store the file
                uploadedImages.push(file);
                // Create preview
                const reader = new FileReader();
                reader.onload = function (e) {
                  const previewItem = document.createElement("div");
                  previewItem.className = "image-preview-item";
                  const img = document.createElement("img");
                  img.src = e.target.result;
                  img.className = "chat-image-preview";
                  const removeBtn = document.createElement("button");
                  removeBtn.className = "remove-image-btn";
                  removeBtn.innerHTML = "×";
                  removeBtn.onclick = function () {
                    // Remove from preview and uploadedImages array
                    const index = uploadedImages.indexOf(file);
                    if (index > -1) {
                      uploadedImages.splice(index, 1);
                    }
                    previewItem.remove();
                  };
                  previewItem.appendChild(img);
                  previewItem.appendChild(removeBtn);
                  imagePreviewContainer.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
              });
              // Reset the file input to allow selecting the same file again
              event.target.value = "";
            }

      // Send message function
            async function sendMessage() {
              const message = userInput.value.trim();
              // If there's no message and no images, do nothing
              if (!message && uploadedImages.length === 0) return;
              // Append user message to chat
              if (message) {
                appendMessage("User", message);
              }
              // Append images to chat
              if (uploadedImages.length > 0) {
                appendImagesToChat(uploadedImages);
              }

              // Scroll to bottom
              chatBox.scrollTop = chatBox.scrollHeight;
              // Prepare form data
              const formData = new FormData();
              formData.append("message", message);
              if (currentStep) {
                formData.append("step", currentStep);
              }

              // Append all uploaded images
              uploadedImages.forEach((image, index) => {
                formData.append("images", image, image_${index}.jpg);
              });

              // Clear inputs
              userInput.value = "";
              clearImagePreviews();
              try {
                // Show typing indicator
                appendTypingIndicator();
                const response = await fetch("https://zomato-backend-2-ge19.onrender.com/api/chat", {
                  method: "POST",
                  headers: {
                    Authorization: Bearer ${localStorage.getItem("token") || ""},
                  },
                  body: formData,
                });
                if (!response.ok) {
                  throw new Error(Server responded with status: ${response.status});
                }
                const data = await response.json();
                // Remove typing indicator
                removeTypingIndicator();
                // Update current step
                currentStep = data.step || null;
                // Append bot response
                appendMessage("Bot", data.reply);
                // Append options if available
                if (data.options && data.options.length) {
                  appendOptions(data.options);
                }
                // Scroll to bottom
                chatBox.scrollTop = chatBox.scrollHeight;
              } catch (error) {
                // Remove typing indicator
                removeTypingIndicator();
                appendMessage("Bot", "❌ Error: Could not connect to server.");
                console.error("Fetch error:", error);
              }
            }

            // Append message to chat
            function appendMessage(sender, text) {
              const msg = document.createElement("div");
              msg.classList.add("mb-2");
              msg.style.textAlign = sender === "User" ? "right" : "left";
              msg.innerHTML = <strong>${sender}:</strong> ${escapeHtml(text)};
              chatBox.appendChild(msg);
            }

            // Append images to chat
            function appendImagesToChat(images) {
              const container = document.createElement("div");
              container.classList.add("mb-2");
              container.style.textAlign = "right";
              Array.from(images).forEach((file) => {
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                img.className = "chat-image-preview";
                img.onload = () => URL.revokeObjectURL(img.src); // Clean up memory
                container.appendChild(img);
              });
              chatBox.appendChild(container);
            }
            // Append options to chat
            function appendOptions(options) {
              const optionsDiv = document.createElement("div");
              optionsDiv.classList.add("mb-2");
              optionsDiv.innerHTML =
                `<strong>Options:</strong> ` +
                options
                  .map(
                    (opt) =>
                      <button class="btn btn-sm btn-outline-light m-1" onclick="sendPredefinedMessage('${opt}')">${opt}</button>
                  )
                  .join(" ");
              chatBox.appendChild(optionsDiv);
            }
            // Send predefined message (for options)
            function sendPredefinedMessage(option) {
              userInput.value = option;
              sendMessage();
            }
            // Show typing indicator
            function appendTypingIndicator() {
              const typingDiv = document.createElement("div");
              typingDiv.id = "typing-indicator";
              typingDiv.classList.add("mb-2");
              typingDiv.style.textAlign = "left";
              typingDiv.innerHTML =
                '<strong>Bot:</strong> <span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>';
              chatBox.appendChild(typingDiv);
              chatBox.scrollTop = chatBox.scrollHeight;
            }
            // Remove typing indicator
            function removeTypingIndicator() {
              const typingIndicator = document.getElementById("typing-indicator");
              if (typingIndicator) {
                typingIndicator.remove();
              }
            }
            // Clear image previews
            function clearImagePreviews() {
              imagePreviewContainer.innerHTML = "";
              uploadedImages = [];
            }
            // Escape HTML to prevent XSS
            function escapeHtml(text) {
              const div = document.createElement("div");
              div.textContent = text;
              return div.innerHTML;
            }
    </script>

    <script>
      // Global variables
      let currentStep = null;
      let uploadedImages = [];

      // DOM elements
      const chatBox = document.getElementById("chat-box");
      const userInput = document.getElementById("user-input");
      const imageUpload = document.getElementById("image-upload");
      const sendButton = document.getElementById("send-button");
      const uploadButton = document.getElementById("upload-button");
      const imagePreviewContainer = document.getElementById(
        "image-preview-container"
      );

      // Event listeners
      document.addEventListener("DOMContentLoaded", function () {
        // Prevent form submissions from causing page reload
        document.addEventListener("submit", function (event) {
          event.preventDefault();
          event.stopPropagation();
        });

        // Send message on button click
        sendButton.addEventListener("click", sendMessage);

        // Send message on Enter key
        userInput.addEventListener("keydown", function (event) {
          if (event.key === "Enter") {
            event.preventDefault();
            sendMessage();
          }
        });

        // Handle image upload button click
        uploadButton.addEventListener("click", function () {
          imageUpload.click();
        });

        // Handle image selection
        imageUpload.addEventListener("change", handleImageSelection);
      });

      // Handle image selection
      function handleImageSelection(event) {
        const files = event.target.files;
        if (!files || files.length === 0) return;

        Array.from(files).forEach((file) => {
          if (!file.type.match("image.*")) return;

          uploadedImages.push(file);

          const reader = new FileReader();
          reader.onload = function (e) {
            const previewItem = document.createElement("div");
            previewItem.className = "image-preview-item";

            const img = document.createElement("img");
            img.src = e.target.result;
            img.className = "chat-image-preview";

            const removeBtn = document.createElement("button");
            removeBtn.className = "remove-image-btn";
            removeBtn.innerHTML = "×";
            removeBtn.onclick = function () {
              const index = uploadedImages.indexOf(file);
              if (index > -1) uploadedImages.splice(index, 1);
              previewItem.remove();
            };

            previewItem.appendChild(img);
            previewItem.appendChild(removeBtn);
            imagePreviewContainer.appendChild(previewItem);
          };
          reader.readAsDataURL(file);
        });

        event.target.value = "";
      }

      // Send message function
      async function sendMessage() {
        const message = userInput.value.trim();
        if (!message && uploadedImages.length === 0) return;

        if (message) appendMessage("User", message);
        if (uploadedImages.length > 0) appendImagesToChat(uploadedImages);

        chatBox.scrollTop = chatBox.scrollHeight;

        const formData = new FormData();
        formData.append("message", message);
        if (currentStep) formData.append("step", currentStep);

        uploadedImages.forEach((image, index) => {
          formData.append("images", image, `image_${index}.jpg`);
        });

        userInput.value = "";
        clearImagePreviews();

        try {
          appendTypingIndicator();

          const response = await fetch("http://localhost:5000/api/chat", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token") || ""}`,
            },
            body: formData,
          });

          if (!response.ok)
            throw new Error(`Server responded with status: ${response.status}`);

          const data = await response.json();

          removeTypingIndicator();
          currentStep = data.step || null;

          appendMessage("Bot", data.reply || "");

          if (data.options && data.options.length) {
            appendOptions(data.options);
          }

          chatBox.scrollTop = chatBox.scrollHeight;
        } catch (error) {
          removeTypingIndicator();
          appendMessage("Bot", "❌ Error: Could not connect to server.");
          console.error("Fetch error:", error);
        }
      }

      // Append message
      function appendMessage(sender, text) {
        const msg = document.createElement("div");
        msg.classList.add("mb-2");
        msg.style.textAlign = sender === "User" ? "right" : "left";
        msg.innerHTML = `<strong>${sender}:</strong> ${escapeHtml(text)}`;
        chatBox.appendChild(msg);
      }

      // Append images to chat (user side)
      function appendImagesToChat(images) {
        const container = document.createElement("div");
        container.classList.add("mb-2");
        container.style.textAlign = "right";
        Array.from(images).forEach((file) => {
          const img = document.createElement("img");
          img.src = URL.createObjectURL(file);
          img.className = "chat-image-preview";
          img.onload = () => URL.revokeObjectURL(img.src);
          container.appendChild(img);
        });
        chatBox.appendChild(container);
      }

      // Append images from server (history)
      function appendImagesFromServer(imageUrls) {
        const container = document.createElement("div");
        container.classList.add("mb-2");
        container.style.textAlign = "right";
        imageUrls.forEach((url) => {
          const img = document.createElement("img");
          img.src = url;
          img.className = "chat-image-preview";
          container.appendChild(img);
        });
        chatBox.appendChild(container);
      }

      // Append options
      function appendOptions(options) {
        const optionsDiv = document.createElement("div");
        optionsDiv.classList.add("mb-2");
        optionsDiv.innerHTML =
          `<strong>Options:</strong> ` +
          options
            .map(
              (opt) =>
                `<button class="btn btn-sm btn-outline-light m-1" onclick="sendPredefinedMessage('${opt}')">${opt}</button>`
            )
            .join(" ");
        chatBox.appendChild(optionsDiv);
      }

      // Send predefined message
      function sendPredefinedMessage(option) {
        userInput.value = option;
        sendMessage();
      }

      // Typing indicator
      function appendTypingIndicator() {
        const typingDiv = document.createElement("div");
        typingDiv.id = "typing-indicator";
        typingDiv.classList.add("mb-2");
        typingDiv.style.textAlign = "left";
        typingDiv.innerHTML =
          '<strong>Bot:</strong> <span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>';
        chatBox.appendChild(typingDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function removeTypingIndicator() {
        const typingIndicator = document.getElementById("typing-indicator");
        if (typingIndicator) typingIndicator.remove();
      }

      // Clear previews
      function clearImagePreviews() {
        imagePreviewContainer.innerHTML = "";
        uploadedImages = [];
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // JWT helper
      function parseJwt(token) {
        try {
          const base64Url = token.split(".")[1];
          const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
          return JSON.parse(window.atob(base64));
        } catch (e) {
          console.error("JWT decode error:", e);
          return null;
        }
      }

      // Load chat history
      async function loadChatHistory(userId) {
        try {
          const response = await fetch(
            `https://zomato-backend-2-ge19.onrender.com/api/chat/${userId}`,
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token") || ""}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok)
            throw new Error(`Error ${response.status}: Unable to fetch chat`);

          const data = await response.json();
          chatBox.innerHTML = "";

          if (data.messages && data.messages.length > 0) {
            data.messages.forEach((msg) => {
              appendMessage(
                msg.role === "user" ? "User" : "Bot",
                msg.text || ""
              );
              if (msg.images && msg.images.length > 0) {
                appendImagesFromServer(msg.images);
              }
            });
          } else {
            appendMessage("Bot", "No previous chat history.");
          }

          chatBox.scrollTop = chatBox.scrollHeight;
        } catch (error) {
          console.error("Chat history error:", error);
          appendMessage("Bot", "❌ Could not load chat history.");
        }
      }

      // Load history on DOM ready
      document.addEventListener("DOMContentLoaded", function () {
        const token = localStorage.getItem("token");
        if (token) {
          const decoded = parseJwt(token);
          const userId = decoded?.id;
          if (userId) {
            loadChatHistory(userId);
          } else {
            appendMessage("Bot", "⚠ Could not extract userId from token.");
          }
        } else {
          appendMessage(
            "Bot",
            "⚠ Please log in first to see your chat history."
          );
        }
      });
    </script>

    <!-- Note: The error in main.js (line 68: getContext) suggests a missing canvas element for chart.js. -->
    <!-- If you don't need charts, remove <script src="lib/chart/chart.min.js"></script> from the HTML. -->
    <!-- Otherwise, add <canvas id="myChart"></canvas> where needed and ensure main.js references it correctly. -->
    <!-- Check main.js around line 68 for: document.getElementById('myChart').getContext('2d') and verify the element exists. -->
  </body>
</html>
